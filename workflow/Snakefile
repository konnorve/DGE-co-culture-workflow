# The main entry point of your workflow.
# After configuring, running snakemake -n in a clone of this repository should successfully execute a dry-run of the workflow.
from pathlib import Path
import shutil

# report: "report/workflow.rst"


configfile: "config/config.yaml"


SAMPLES = glob_wildcards(
    Path(config["input"]["raw_reads"])
    # / "2019_dark_adapted_transcriptome_sequencing_{sample}.fastq.bz2"
    / "2021_Sar11Pro_RNAseq_Project_{sample}_1_sequence.fastq.gz"
).sample


output_path_dict = {
    "done_files": Path(config["scratch_dir"]) / "done_files",
    "trimmed_reads": Path(config["scratch_dir"]) / "trimmed_reads",
    "concat_gff": {
        "concat_gff_file": Path(config["scratch_dir"])
        / "concat_gff"
        / "concat_gff.gff",
        "concat_gff_mod_file": Path(config["scratch_dir"])
        / "concat_gff"
        / "concat_gff_mod.gff",
    },
    "concat_genome": {
        "concat_genome_file": Path(config["scratch_dir"])
        / "concat_genome"
        / "concat_genome.fna",
        "concat_genome_done": Path(config["scratch_dir"])
        / "concat_genome"
        / "indexed.done",
    },
    "mapped_reads": Path(config["scratch_dir"]) / "mapped_reads",
    "feature_count": Path(config["scratch_dir"]) / "HTseq",
    "genome_index_parent": Path(config["scratch_dir"]) / "genome_index",
    "library_count": Path(config["scratch_dir"])
    / "raw_library_counts"
    / "library_len.tsv",
    "coverage_positions": Path(config["scratch_dir"]) / "coverage_positions",
    "fastqc": Path(config["scratch_dir"]) / "fastqc",
}

results_path_dict = {
    "counts": Path(config["results"]) / "counts.tsv",
    "metadata": Path(config["results"]) / "metadata.tsv",
    "config": Path(config["results"]) / "config.yaml",
    "samples": Path(config["results"]) / "samples.tsv",
    "results": Path(config["results"]) / "results.tsv",
    "rlog": Path(config["results"]) / "rlog.tsv",
    "kegg_refs": Path(config["results"]) / "kegg_refs.tsv",
}


rule all:
    input:
        list(results_path_dict.values()),
        expand(
            output_path_dict["fastqc"] / "{sample}_{read}_trimmed_fastqc.html",
            sample=SAMPLES,
            read=[1, 2],
        ),


include: "rules/counting_features.smk"


include: "rules/genome_concat.smk"


include: "rules/gff_tools.smk"


if config["aligner"] == "hisat2":

    include: "rules/map_reads_hisat2.smk"


if config["aligner"] == "bwa":

    include: "rules/map_reads_bwa.smk"


if config["aligner"] == "bowtie2":

    include: "rules/map_reads_bowtie2.smk"


include: "rules/post_htseq2_parsing.smk"


include: "rules/run_trim.smk"


include: "rules/samtools.smk"


include: "rules/unzip.smk"


include: "rules/fastqc.smk"
